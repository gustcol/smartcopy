# SmartCopy High-Speed Network Tuning
# Generated by Ansible for {{ smartcopy_network_speed }} network
# Applied to: {{ ansible_hostname }}

# TCP Buffer Sizes
net.core.rmem_max={{ network_tuning[smartcopy_network_speed].rmem_max }}
net.core.wmem_max={{ network_tuning[smartcopy_network_speed].wmem_max }}
net.ipv4.tcp_rmem={{ network_tuning[smartcopy_network_speed].tcp_rmem }}
net.ipv4.tcp_wmem={{ network_tuning[smartcopy_network_speed].tcp_wmem }}

# Network Device Settings
net.core.netdev_max_backlog={{ network_tuning[smartcopy_network_speed].netdev_max_backlog }}
{% if network_tuning[smartcopy_network_speed].netdev_budget is defined %}
net.core.netdev_budget={{ network_tuning[smartcopy_network_speed].netdev_budget }}
{% endif %}
{% if network_tuning[smartcopy_network_speed].optmem_max is defined %}
net.core.optmem_max={{ network_tuning[smartcopy_network_speed].optmem_max }}
{% endif %}
net.core.somaxconn={{ network_tuning[smartcopy_network_speed].somaxconn }}

# TCP Performance
net.ipv4.tcp_congestion_control=bbr
net.ipv4.tcp_mtu_probing=1
net.ipv4.tcp_timestamps=1
net.ipv4.tcp_sack=1
net.ipv4.tcp_window_scaling=1
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_low_latency=1
net.ipv4.tcp_no_metrics_save=1

# UDP Buffer Sizes (for QUIC)
net.core.rmem_default=262144
net.core.wmem_default=262144

# File Descriptors
fs.file-max=2097152
fs.nr_open=2097152

# VM Settings for Large Transfers
vm.dirty_ratio=40
vm.dirty_background_ratio=10
vm.swappiness=10
vm.vfs_cache_pressure=50

# IPv4 Settings
net.ipv4.ip_local_port_range=1024 65535
net.ipv4.tcp_fin_timeout=10
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_max_syn_backlog=65535
net.ipv4.tcp_max_tw_buckets=2000000

{% if smartcopy_network_speed in ['200g', '400g'] %}
# Additional tuning for 200G+ networks
net.ipv4.tcp_slow_start_after_idle=0
net.ipv4.tcp_moderate_rcvbuf=1
net.ipv4.tcp_adv_win_scale=1
{% endif %}
